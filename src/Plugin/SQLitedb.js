const a0_0x51c0cc=a0_0x34c1;(function(_0x39b847,_0x5f398b){const _0x2d5b40=a0_0x34c1,_0x487f89=_0x39b847();while(!![]){try{const _0x583e28=-parseInt(_0x2d5b40(0x1ec))/0x1+parseInt(_0x2d5b40(0x205))/0x2+-parseInt(_0x2d5b40(0x219))/0x3+parseInt(_0x2d5b40(0x1e0))/0x4+parseInt(_0x2d5b40(0x1d8))/0x5*(-parseInt(_0x2d5b40(0x1fa))/0x6)+parseInt(_0x2d5b40(0x214))/0x7+-parseInt(_0x2d5b40(0x1eb))/0x8*(-parseInt(_0x2d5b40(0x1d9))/0x9);if(_0x583e28===_0x5f398b)break;else _0x487f89['push'](_0x487f89['shift']());}catch(_0x1843aa){_0x487f89['push'](_0x487f89['shift']());}}}(a0_0x2c96,0xcb052));const sqlite3=require('sqlite3'),{open}=require(a0_0x51c0cc(0x1df)),path=require(a0_0x51c0cc(0x1e5)),chalk=require(a0_0x51c0cc(0x20d));class DatabaseManager{static async[a0_0x51c0cc(0x209)](_0x3ff10a){const _0x1089ff=a0_0x51c0cc;await _0x3ff10a[_0x1089ff(0x1da)](_0x1089ff(0x1f9)),await _0x3ff10a['exec']('PRAGMA\x20synchronous\x20=\x20NORMAL;'),await _0x3ff10a[_0x1089ff(0x1da)](_0x1089ff(0x1fb)),await _0x3ff10a['exec'](_0x1089ff(0x1e4)),await _0x3ff10a[_0x1089ff(0x1da)](_0x1089ff(0x1fd)),await _0x3ff10a[_0x1089ff(0x1da)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_remoteJid_timestamp\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ON\x20messages\x20(remoteJid,\x20timestamp\x20DESC)\x0a\x20\x20\x20\x20\x20\x20\x20\x20');}}class MessageQueueProcessor{constructor(_0x501c66){const _0x597088=a0_0x51c0cc;this['db']=_0x501c66,this[_0x597088(0x206)]=[],this[_0x597088(0x224)]=[],this[_0x597088(0x20b)]=![];}async[a0_0x51c0cc(0x1f2)](){const _0x4c92d9=a0_0x51c0cc;if(this[_0x4c92d9(0x20b)]||this[_0x4c92d9(0x206)][_0x4c92d9(0x1e7)]===0x0&&this[_0x4c92d9(0x224)][_0x4c92d9(0x1e7)]===0x0)return;this[_0x4c92d9(0x20b)]=!![];try{await this['db'][_0x4c92d9(0x1d6)](_0x4c92d9(0x1f4));const _0x4ffebb=await this['db'][_0x4c92d9(0x222)](_0x4c92d9(0x20e)),_0xbd7f88=await this['db'][_0x4c92d9(0x222)](_0x4c92d9(0x202));while(this[_0x4c92d9(0x206)][_0x4c92d9(0x1e7)]>0x0){const _0x362efb=this['writeQueue'][_0x4c92d9(0x217)](),{key:_0x5b05c3,messageTimestamp:_0x36ea45,pushName:_0x1fb86f,participant:_0xba5a7,type:_0x500a42}=_0x362efb;await _0x4ffebb[_0x4c92d9(0x1d6)](_0x5b05c3['id'],_0x5b05c3[_0x4c92d9(0x20a)],JSON[_0x4c92d9(0x1e3)](_0x362efb),_0x36ea45,_0x1fb86f,_0xba5a7,_0x500a42);}while(this[_0x4c92d9(0x224)][_0x4c92d9(0x1e7)]>0x0){const {jid:_0x3e3237,pushName:_0x1482ef}=this['pushNameQueue'][_0x4c92d9(0x217)]();await _0xbd7f88[_0x4c92d9(0x1d6)](_0x3e3237,_0x1482ef,Math[_0x4c92d9(0x1de)](Date[_0x4c92d9(0x215)]()/0x3e8));}await _0x4ffebb[_0x4c92d9(0x1e2)](),await _0xbd7f88[_0x4c92d9(0x1e2)](),await this['db'][_0x4c92d9(0x1d6)](_0x4c92d9(0x1ed));}catch(_0x114fc2){console[_0x4c92d9(0x216)](chalk[_0x4c92d9(0x1fe)](_0x4c92d9(0x213),_0x114fc2)),await this['db'][_0x4c92d9(0x1d6)](_0x4c92d9(0x1f1));if(this[_0x4c92d9(0x206)]['length']===0x0)this[_0x4c92d9(0x206)][_0x4c92d9(0x204)](...this['writeQueue']);if(this['pushNameQueue'][_0x4c92d9(0x1e7)]===0x0)this['pushNameQueue'][_0x4c92d9(0x204)](...this[_0x4c92d9(0x224)]);}finally{this[_0x4c92d9(0x20b)]=![],setTimeout(()=>this['processQueue'](),0x64);}}[a0_0x51c0cc(0x1ef)](_0x3614a1){const _0x491500=a0_0x51c0cc;this[_0x491500(0x206)][_0x491500(0x21d)](_0x3614a1),!this[_0x491500(0x20b)]&&this['processQueue']();}['addPushNameToQueue'](_0x9980e7,_0x59a199){const _0x303906=a0_0x51c0cc;this[_0x303906(0x224)][_0x303906(0x21d)]({'jid':_0x9980e7,'pushName':_0x59a199}),!this[_0x303906(0x20b)]&&this[_0x303906(0x1f2)]();}}function a0_0x2c96(){const _0x51e54f=['PRAGMA\x20journal_mode\x20=\x20WAL;','353970UuCMbd','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20messages\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20id\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20remoteJid\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20message\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20timestamp\x20INTEGER,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20pushName\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20participant\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20messageType\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20PRIMARY\x20KEY\x20(id,\x20remoteJid)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20','split','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20INDEX\x20IF\x20NOT\x20EXISTS\x20idx_remoteJid\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ON\x20messages\x20(remoteJid)\x0a\x20\x20\x20\x20\x20\x20\x20\x20','red','writeMessage','SELECT\x20message\x20FROM\x20messages\x20WHERE\x20id\x20=\x20?','close','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INSERT\x20OR\x20REPLACE\x20INTO\x20push_names\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(jid,\x20push_name,\x20last_updated)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','all','unshift','1212902TiEpyg','writeQueue','_cleanJid','User','createSchema','remoteJid','isProcessingQueue','DELETE\x20FROM\x20messages\x20WHERE\x20timestamp\x20<\x20?','chalk','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INSERT\x20OR\x20REPLACE\x20INTO\x20messages\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(id,\x20remoteJid,\x20message,\x20timestamp,\x20pushName,\x20participant,\x20messageType)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20VALUES\x20(?,\x20?,\x20?,\x20?,\x20?,\x20?,\x20?)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','join','DatabaseManager','addPushNameToQueue','includes','Error\x20processing\x20write\x20queue:','4246186MDrTKp','now','error','shift','status@broadcast','2843877YbfsUg','push_name','SELECT\x20message\x20FROM\x20messages\x20WHERE\x20remoteJid\x20=\x20?\x20ORDER\x20BY\x20timestamp\x20DESC\x20LIMIT\x20?','logger','push','messages.upsert','SELECT\x20message\x20FROM\x20messages\x20WHERE\x20remoteJid\x20=\x20?\x20AND\x20id\x20=\x20?','participant','clearOldMessages','prepare','Error\x20initializing\x20SQLite\x20store:','pushNameQueue','getChatHistory','get','run','green','105necHjl','9cgtZwP','exec','SQLite\x20store\x20initialized\x20successfully','@s.whatsapp.net','messages.db','floor','sqlite','5377876StIIis','queueProcessor','finalize','stringify','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20CREATE\x20TABLE\x20IF\x20NOT\x20EXISTS\x20push_names\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20jid\x20TEXT\x20PRIMARY\x20KEY,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20push_name\x20TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20last_updated\x20INTEGER\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20','path','pushName','length','parse','message','Error\x20closing\x20database\x20connection:','15311376LSxoId','1453016RtWaRz','COMMIT','VACUUM','addToQueue','Error\x20getting\x20pushName:\x20','ROLLBACK','processQueue','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20pushName\x20FROM\x20messages\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20(remoteJid\x20=\x20?\x20OR\x20participant\x20=\x20?)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20pushName\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20pushName\x20!=\x20\x27\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x20timestamp\x20DESC\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','BEGIN\x20TRANSACTION','key','findMessageById','Error\x20getting\x20chat\x20history:','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20push_name\x20FROM\x20push_names\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x20jid\x20=\x20?\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'];a0_0x2c96=function(){return _0x51e54f;};return a0_0x2c96();}function a0_0x34c1(_0x555a97,_0x3c3f43){const _0x2c9641=a0_0x2c96();return a0_0x34c1=function(_0x34c11e,_0x456cfa){_0x34c11e=_0x34c11e-0x1d6;let _0x5e58b8=_0x2c9641[_0x34c11e];return _0x5e58b8;},a0_0x34c1(_0x555a97,_0x3c3f43);}class SQLiteMessageStore{constructor(_0x28df0e){const _0x40c88e=a0_0x51c0cc;this[_0x40c88e(0x21c)]=_0x28df0e,this['db']=null,this[_0x40c88e(0x1e1)]=null;}async['initialize'](){const _0x225f3e=a0_0x51c0cc;try{this['db']=await open({'filename':path[_0x225f3e(0x20f)](__dirname,'..',_0x225f3e(0x1dd)),'driver':sqlite3['Database']}),await DatabaseManager[_0x225f3e(0x209)](this['db']),this[_0x225f3e(0x1e1)]=new MessageQueueProcessor(this['db']),console['log'](chalk[_0x225f3e(0x1d7)](_0x225f3e(0x1db)));}catch(_0x1e823e){console[_0x225f3e(0x216)](chalk['red'](_0x225f3e(0x223),_0x1e823e));throw _0x1e823e;}}async[a0_0x51c0cc(0x1ff)](_0x5326e9){const _0x29e572=a0_0x51c0cc;this[_0x29e572(0x1e1)][_0x29e572(0x1ef)](_0x5326e9);if(_0x5326e9['pushName']){const _0x361674=this['_cleanJid'](_0x5326e9[_0x29e572(0x1f5)][_0x29e572(0x220)]||_0x5326e9['key']['remoteJid']);_0x361674!==_0x29e572(0x218)&&this['queueProcessor'][_0x29e572(0x211)](_0x361674,_0x5326e9[_0x29e572(0x1e6)]);}}[a0_0x51c0cc(0x207)](_0x3ba073){const _0x1c8174=a0_0x51c0cc;return _0x3ba073[_0x1c8174(0x212)]('@')?_0x3ba073[_0x1c8174(0x1fc)]('@')[0x0]+_0x1c8174(0x1dc):_0x3ba073;}async['getPushName'](_0x3a3fa0){const _0x3db150=a0_0x51c0cc;try{if(!_0x3a3fa0)return'User';const _0x31d7e1=this[_0x3db150(0x207)](_0x3a3fa0),_0x58de2c=await this['db']['get'](_0x3db150(0x1f8),[_0x31d7e1]);if(_0x58de2c?.[_0x3db150(0x21a)])return _0x58de2c[_0x3db150(0x21a)];const _0x167552=await this['db'][_0x3db150(0x226)](_0x3db150(0x1f3),[_0x31d7e1,_0x31d7e1]);return _0x167552?.[_0x3db150(0x1e6)]||_0x31d7e1['split']('@')[0x0]||_0x3db150(0x208);}catch(_0x24f277){return console['error'](_0x3db150(0x1f0)+_0x24f277),_0x3db150(0x208);}}async['loadMessage'](_0x15c803,_0x3dbaec){const _0x25bb4a=a0_0x51c0cc;try{const _0x9a9472=await this['db'][_0x25bb4a(0x226)](_0x25bb4a(0x21f),[_0x15c803,_0x3dbaec]);return _0x9a9472?JSON[_0x25bb4a(0x1e8)](_0x9a9472[_0x25bb4a(0x1e9)]):undefined;}catch(_0x46f015){return console[_0x25bb4a(0x216)](chalk['red']('Error\x20loading\x20message:',_0x46f015)),undefined;}}async[a0_0x51c0cc(0x1f6)](_0x5db140){const _0x5de015=a0_0x51c0cc;try{const _0x93a707=await this['db'][_0x5de015(0x226)](_0x5de015(0x200),[_0x5db140]);return _0x93a707?JSON[_0x5de015(0x1e8)](_0x93a707[_0x5de015(0x1e9)]):undefined;}catch(_0x1d085a){return console[_0x5de015(0x216)](chalk[_0x5de015(0x1fe)]('Error\x20finding\x20message\x20by\x20ID:',_0x1d085a)),undefined;}}async[a0_0x51c0cc(0x225)](_0x1dff9d,_0x350a62=0x32){const _0x567b79=a0_0x51c0cc;try{return await this['db'][_0x567b79(0x203)](_0x567b79(0x21b),[_0x1dff9d,_0x350a62]);}catch(_0x5849e3){return console[_0x567b79(0x216)](chalk[_0x567b79(0x1fe)](_0x567b79(0x1f7),_0x5849e3)),[];}}async[a0_0x51c0cc(0x221)](_0x5de3a2=0x1){const _0xf19163=a0_0x51c0cc;try{const _0x34b848=Math[_0xf19163(0x1de)](Date[_0xf19163(0x215)]()/0x3e8)-_0x5de3a2*0x18*0x3c*0x3c,_0x1bc9f4=await this['db']['run'](_0xf19163(0x20c),[_0x34b848]);await this['db'][_0xf19163(0x1d6)]('DELETE\x20FROM\x20push_names\x20WHERE\x20last_updated\x20<\x20?',[_0x34b848]),_0x1bc9f4['changes']>0x3e8&&await this['db'][_0xf19163(0x1d6)](_0xf19163(0x1ee));}catch(_0x22ed5d){console['error']('Cleanup\x20error',_0x22ed5d);}}async['bind'](_0x517502){const _0xaadcc4=a0_0x51c0cc;_0x517502['on'](_0xaadcc4(0x21e),async({messages:_0x584101})=>{const _0xb31394=_0xaadcc4;for(const _0x51c7a8 of _0x584101){await this[_0xb31394(0x1ff)](_0x51c7a8);}});}async[a0_0x51c0cc(0x201)](){const _0x4227d0=a0_0x51c0cc;try{this['db']&&(await this['db'][_0x4227d0(0x201)](),console['log'](chalk['green']('Database\x20connection\x20closed\x20successfully')));}catch(_0x5c3a75){console['error'](chalk['red'](_0x4227d0(0x1ea),_0x5c3a75));}}}module['exports']=SQLiteMessageStore,module['exports'][a0_0x51c0cc(0x210)]=DatabaseManager;