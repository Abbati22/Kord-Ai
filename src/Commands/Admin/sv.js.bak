module.exports = {
    usage: ["svcontact"],
    desc: "Save all group members' contacts as a vCard file with WhatsApp display names",
    commandType: "Group",
    isGroupOnly: true,
    isAdminOnly: true,
    isPrivateOnly: false,
    emoji: "üì†",
    execute: async (sock, m) => {
        try {
            // Get group metadata
            const groupMetadata = await sock.groupMetadata(m.key.remoteJid);

            // Initialize vCards string
            let vCards = '';
            
            // Process each participant
            for (const participant of groupMetadata.participants) {
                try {
                    const jid = participant.id;
                    
                    // Fetch contact details for each participant
                    const contact = await sock.onWhatsApp(jid);
                    let name = contact?.[0]?.name || contact?.[0]?.notify || '';

                    // If no name found, use phone number
                    if (!name) {
                        const phoneNumber = jid.split('@')[0];
                        name = phoneNumber;
                    }

                    // Get phone number for vCard
                    const phoneNumber = jid.split('@')[0];
                    
                    // Create vCard
                    const vCard = `BEGIN:VCARD
VERSION:3.0
FN:${name}
N:${name};;;
TEL;type=CELL;type=VOICE;waid=${phoneNumber}:+${phoneNumber}
END:VCARD
`;
                    
                    vCards += vCard + '\n';
                    
                    // Debug log
                    console.log(`Generated vCard for ${name} (${phoneNumber})`);
                    
                } catch (err) {
                    console.error(`Error processing contact:`, err);
                    continue;
                }
            }
            
            if (!vCards) {
                throw new Error('No contact cards were generated');
            }
            
            // Create buffer and send
            const vcfBuffer = Buffer.from(vCards, 'utf-8');
            
            await sock.sendMessage(m.key.remoteJid, {
                document: vcfBuffer,
                fileName: `group_contacts.vcf`,
                mimetype: 'text/vcard',
            }, { quoted: m });
            
            await sock.sendMessage(m.key.remoteJid, { 
                text: "‚úÖ Contact list has been generated and sent!" 
            }, { quoted: m });
            
        } catch (error) {
            console.error("Error in savecontact command:", error);
            await sock.sendMessage(m.key.remoteJid, { 
                text: "‚ùå Failed to generate contacts: " + error.message 
            }, { quoted: m });
        }
    }
};